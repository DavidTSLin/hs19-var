<html>
  <head>
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="https://rawgit.com/protyze/aframe-curve-component/master/dist/aframe-curve-component.min.js"></script>
    <script src="https://rawgit.com/protyze/aframe-alongpath-component/master/dist/aframe-alongpath-component.min.js"></script>
    <!-- <script src="https://unpkg.com/aframe-curve-component/dist/aframe-curve-component.min.js"></script> -->
    <!-- wasd-controls -->
  </head>
  <body>
    <a-scene id="test">
        <a-camera id="curve-camera" position="-1.2 0 1" look-controls wasd-controls="acceleration: 20"></a-camera>
        <a-curve id="track1"></a-curve>
        <!-- <a-box alongpath="curve: #track1; loop: true"></a-box> -->
        <a-draw-curve curveref="#track1" material="shader: line; color: blue;"></a-draw-curve>
        <a-entity position="0 0 0" id="cells"></a-entity>
        <a-sky></a-sky>
    </a-scene>
    <script>

        states = ["stop", "forward", "stop", "backward"]
        currentState = "stop";

        const getCameraTrajectory = () => {
            return fetch('data/curves.json')
                .then(response => response.text())
                .then(text => {
                    const coords = JSON.parse(text);
                    const rotations = [];
                    const positions = [];
                    coords.forEach((coord, _) => {
                        const position = `${coord.x} ${coord.y} ${coord.z}`;
                        positions.push(position);
                        const rotation = coord.rotation.join(" ");
                        rotations.push(rotation);
                    });
                    return [positions, rotations];
                });
        }

        const getCurvePoints = () => {
            return fetch('data/curves.json')
            .then(response => response.text())
            .then(text => {
                const coords = JSON.parse(text);
                const curvePoints = [];
                coords.forEach((coord, _) => {
                    const curvePoint = `<a-curve-point position="${coord.x} ${coord.y} ${coord.z}"></a-curve-point>`;
                    curvePoints.push(curvePoint);
                });  
                return curvePoints;
            });
        }

        const getCells = () => {
            return fetch('data/cells.json')
                .then(response => response.text())
                .then(text => {
                    const cell_points = JSON.parse(text);
                    const cells = [];
                    cell_points.forEach((cell_point, _) => {
                        const stream_cell = `<a-sphere position="${cell_point.x} ${cell_point.y} ${cell_point.z}" color="${cell_point.color}" radius=".0005" shadow></a-sphere>`;
                        cells.push(stream_cell);
                    })
                    return cells;
                });
        }

        getCurvePoints()
            .then((curvePoints) => {
            const curve_el = document.getElementById("track1");
            curve_el.innerHTML = curvePoints.join(" ");
            });

        getCells()
            .then((cells) => {
            const cell_el = document.getElementById("cells");
            cell_el.innerHTML = cells.join(" ");
            });


        const scene = document.getElementById("test");   
        let clickCount = 1; 
        document.addEventListener("keydown", event => {
            console.log(event.keyCode);
            if (event.keyCode === 13) {
                currentState = states[clickCount % states.length];
                clickCount = clickCount + 1;    
            }
        });

        document.addEventListener("touchstart", () => {
            currentState = states[clickCount % states.length];
            clickCount = clickCount + 1;    
        })

        let positionIndex = 0
        const moveForward = (positions, rotations) => {
            if (positionIndex !== positions.length) {
                const camera_el = document.getElementById("curve-camera");
                position = positions[positionIndex];
                rotation = rotations[positionIndex];
                camera_el.setAttribute("position", position);
                camera_el.setAttribute("rotation", rotation);
                positionIndex = positionIndex + 1; 
            }
        }

        const moveBackward = (positions, rotations) => {
            if (positionIndex !== 0) {
                const camera_el = document.getElementById("curve-camera");
                position = positions[positionIndex];
                rotation = rotations[positionIndex];
                camera_el.setAttribute("position", position);
                camera_el.setAttribute("rotation", rotation);
                positionIndex = positionIndex - 1; 
            }
        }

        // document.addEventListener("keydown", event => {
        //     if (event.keyCode === 38) {
        //         getCameraTrajectory()
        //             .then((positions) => {
        //                 const camera_el = document.getElementById("curve-camera");
        //                 position = positions[clickCount];
        //                 camera_el.setAttribute("position", position);
        //                 clickCount = clickCount + 1;        
        //         });
        //     }
        //     else if (event.keyCode === 40) {
        //         getCameraTrajectory()
        //             .then((positions) => {
        //                 const camera_el = document.getElementById("curve-camera");
        //                 position = positions[clickCount];
        //                 camera_el.setAttribute("position", position);
        //                 clickCount = clickCount - 1;        
        //         });
        //     }
        // });

        const moveCamera = async () => {
            const [positions, rotations] = await getCameraTrajectory();
            setInterval(() => {
                console.log(currentState);
                if (currentState === "forward") {
                    moveForward(positions, rotations);
                }
                else if (currentState === "backward") {
                    moveBackward(positions, rotations);
                }
            }, 1000);
        }
        
        moveCamera();
    </script>
  </body>
</html>
